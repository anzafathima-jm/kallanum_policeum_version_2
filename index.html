<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>KALLANUM POLICEUM ¬∑ Royal Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:ital,wght@0,600;1,600&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ===== ROYAL COLOR SCHEME - EXACT MATCH ===== */
    :root {
      --gold: #d4af37;              /* Primary gold - borders, highlights */
      --deep-gold: #b8893c;          /* Deep gold - secondary accents, pill backgrounds */
      --mahogany: #2a120a;           /* Main container background - deep royal brown */
      --obsidian: #0f0c08;           /* Near black - panel backgrounds, text shadows */
      --parchment: #f3e2c7;          /* Off-white - text, input backgrounds */
      --royal-red: #8b1a1a;          /* Royal red - buttons, thief elements */
      --emerald: #1e3d33;            /* Emerald green - success, safe badges */
    }

    body {
      background: 
        url('https://www.transparenttextures.com/patterns/dark-matter.png'),
        radial-gradient(circle at top, #3d1c12 0%, var(--obsidian) 100%);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      font-family: 'Montserrat', sans-serif;
      color: var(--parchment);
    }

    .game-container {
      max-width: 780px;
      width: 100%;
      background: var(--mahogany) url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
      border: 8px double var(--gold);
      border-radius: 24px;
      box-shadow: 0 50px 100px rgba(0,0,0,0.9), 0 0 30px rgba(212, 175, 55, 0.1);
      padding: 2rem 1rem;
      text-align: center;
      position: relative;
    }

    h1 {
      font-family: 'Cinzel', serif;
      font-size: clamp(1.8rem, 8vw, 3.2rem);
      color: var(--gold);
      letter-spacing: 5px;
      margin-bottom: 0.1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      text-transform: uppercase;
    }

    .sub {
      font-family: 'Playfair Display', serif;
      font-style: italic;
      color: var(--deep-gold);
      font-size: clamp(0.9rem, 3.5vw, 1.2rem);
      margin: 0.2rem 0 1.5rem 0;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
      padding-bottom: 1rem;
      display: block;
    }

    .ui-panel {
      background: rgba(15, 12, 8, 0.7);  /* var(--obsidian) with opacity */
      border: 1px solid rgba(212, 175, 55, 0.3);  /* var(--gold) with opacity */
      border-radius: 16px;
      padding: 1.8rem 1rem;
      margin: 1rem 0;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }

    button {
      background: linear-gradient(145deg, var(--royal-red), #4a0f0f);
      border: 2px solid var(--gold);
      color: white;
      font-family: 'Cinzel', serif;
      font-weight: bold;
      font-size: clamp(0.9rem, 4vw, 1.3rem);
      padding: 0.8rem 1.5rem;
      border-radius: 4px; /* Square/Formal buttons */
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 2px;
      width: fit-content;
      min-width: 180px;
      margin: 0.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }

    button:hover {
      background: linear-gradient(145deg, #a52222, var(--royal-red));
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
      border-color: var(--gold);
    }

    button:active { 
      transform: translateY(1px); 
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .flex-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.8rem;
      margin: 0.8rem 0;
    }

    .player-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.6rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 8px;
      padding: 0.8rem;
      margin: 0.6rem 0;
    }

    .player-row input {
      flex: 4 1 180px;
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--deep-gold);
      color: var(--parchment);
      padding: 0.6rem 1rem;
      border-radius: 4px;
      font-family: 'Montserrat', sans-serif;
      font-size: clamp(0.9rem, 3.5vw, 1.2rem);
    }

    .player-row input.default-name {
      color: #888888;
      font-style: italic;
    }

    .player-row input:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(0,0,0,0.6);
    }

    .pill-count {
      background: var(--deep-gold);
      color: var(--obsidian);
      font-family: 'Cinzel', serif;
      font-size: 1.2rem;
      font-weight: bold;
      padding: 0.4rem 1.2rem;
      border-radius: 4px;
      white-space: nowrap;
    }

    /* THE PARCHMENT ROLE CARD */
    .role-card {
      background: #fdf5e6 url('https://www.transparenttextures.com/patterns/cream-paper.png');
      color: var(--mahogany);
      border: 10px double var(--deep-gold);
      padding: 2.5rem 1rem;
      border-radius: 0; /* Traditional parchment isn't rounded */
      font-family: 'Cinzel', serif;
      font-size: clamp(2.5rem, 10vw, 4.5rem);
      margin: 1.5rem 0;
      box-shadow: 0 20px 50px rgba(0,0,0,0.7);
      text-align: center;
    }

    .role-card small {
      font-family: 'Montserrat', sans-serif;
      font-size: clamp(1rem, 4vw, 1.5rem);
      display: block;
      color: #6b3a22;  /* Darker mahogany variant */
      margin-top: 0.5rem;
      font-weight: bold;
      letter-spacing: 3px;
    }

    .active-badge {
      background: var(--emerald);
      border: 2px solid var(--gold);
      color: white;
      padding: 0.6rem 2rem;
      border-radius: 4px;
      font-family: 'Cinzel', serif;
      font-size: 1.1rem;
      white-space: nowrap;
    }

    .noble-tag {
      background: var(--deep-gold);
      color: var(--obsidian);
      font-family: 'Cinzel', serif;
      font-weight: bold;
      padding: 0.4rem 1.2rem;
      border-radius: 4px;
      font-size: 1.1rem;
      white-space: nowrap;
    }

    .score {
      color: var(--gold);
      font-size: 1.3rem;
      margin-left: auto;
      font-weight: bold;
      white-space: nowrap;
    }

    .guess-section {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0;
    }

    .guess-label {
      color: var(--parchment);
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 0.5rem;
    }

    .guess-role {
      color: var(--gold);
      font-family: 'Cinzel', serif;
      font-size: clamp(1.8rem, 5vw, 2.2rem);
      margin: 1rem 0;
    }

    .guess-input {
      width: 100%;
      background: rgba(0,0,0,0.5);
      border: 1px solid var(--gold);
      color: var(--parchment);
      padding: 1rem;
      border-radius: 4px;
      font-family: 'Montserrat', sans-serif;
      font-size: 1.1rem;
      margin: 0.8rem 0;
    }

    .guess-input:focus {
      outline: none;
      border-color: var(--deep-gold);
      background: rgba(0,0,0,0.7);
    }

    .hierarchy-line {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.4rem 0.8rem;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(212, 175, 55, 0.2);
      padding: 0.8rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .hierarchy-item {
      color: var(--parchment);
      font-size: 0.9rem;
      white-space: nowrap;
      opacity: 0.7;
    }

    .hierarchy-item.active {
      color: var(--gold);
      opacity: 1;
      font-weight: bold;
      text-decoration: underline;
    }

    /* LEADERBOARD */
    .leaderboard-entry {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      background: rgba(0,0,0,0.3);
      border-bottom: 2px solid var(--deep-gold);
      padding: 1rem;
      font-family: 'Cinzel', serif;
      font-size: 1.3rem;
      margin: 0.5rem 0;
    }

    /* Scrollable player list */
    .player-list-scroll {
      max-height: 350px;
      overflow-y: auto;
      padding-right: 5px;
      margin: 0.5rem 0;
    }

    .player-list-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .player-list-scroll::-webkit-scrollbar-track {
      background: var(--obsidian);
      border-radius: 10px;
    }

    .player-list-scroll::-webkit-scrollbar-thumb {
      background: var(--deep-gold);
      border-radius: 10px;
    }

    /* ===== EFFECT OVERLAYS ===== */
    .effect-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      animation: fadeBgIn 0.3s ease-out;
    }

    @keyframes fadeBgIn {
      from { background: rgba(0,0,0,0); backdrop-filter: blur(0); }
      to { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    }

    .correct-card {
      background: var(--emerald) url('https://www.transparenttextures.com/patterns/dark-matter.png');
      border: 5px solid var(--gold);
      border-radius: 0;
      color: white;
      font-family: 'Cinzel', serif;
      font-size: 2.5rem;
      padding: 2rem 3rem;
      text-align: center;
      transform: scale(0);
      animation: correctPop 1s ease-out forwards;
    }

    .correct-card small {
      font-size: 1.2rem;
      display: block;
      margin-top: 1rem;
      color: var(--gold);
    }

    .swap-card {
      background: var(--royal-red) url('https://www.transparenttextures.com/patterns/dark-matter.png');
      border: 5px solid var(--gold);
      border-radius: 0;
      color: white;
      font-family: 'Cinzel', serif;
      font-size: 2rem;
      padding: 2rem 3rem;
      text-align: center;
      transform: translateX(-200%);
      animation: swapSwing 0.8s ease-out forwards;
    }

    .swap-detail {
      font-size: 1.2rem;
      margin-top: 1rem;
      padding: 0.8rem;
      background: rgba(0,0,0,0.4);
    }

    .swap-detail span {
      display: inline-block;
      background: var(--gold);
      color: var(--obsidian);
      padding: 0.2rem 1rem;
      margin: 0.2rem;
      font-weight: bold;
    }

    @keyframes correctPop {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes swapSwing {
      0% { transform: translateX(-200%) rotate(-20deg); opacity: 0; }
      40% { transform: translateX(20px) rotate(5deg); opacity: 1; }
      70% { transform: translateX(-10px) rotate(-2deg); }
      100% { transform: translateX(0) rotate(0); opacity: 1; }
    }

    .round-score-badge {
      background: var(--deep-gold);
      color: var(--obsidian);
      font-size: 1rem;
      padding: 0.2rem 0.8rem;
      display: inline-block;
      margin: 0.3rem;
      font-family: 'Cinzel', serif;
    }

    /* King Reveal Screen */
    .king-reveal .label {
      color: var(--parchment);
      font-size: 1.2rem;
      opacity: 0.7;
    }

    .king-reveal .role {
      color: var(--gold);
      font-size: 4rem;
      font-family: 'Cinzel', serif;
      margin: 0.5rem 0;
    }

    .king-reveal .points {
      color: var(--deep-gold);
      font-size: 2rem;
      margin-bottom: 2rem;
    }

    /* Active Player Section */
    .active-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      background: rgba(0,0,0,0.3);
      padding: 0.8rem 1.5rem;
      border-radius: 4px;
      border: 1px solid rgba(212, 175, 55, 0.2);
      margin-bottom: 1.5rem;
    }

    .active-section .label {
      color: var(--parchment);
      opacity: 0.7;
    }

    .active-section .name {
      color: var(--parchment);
      font-weight: bold;
    }

    .active-section .role {
      color: var(--gold);
      font-weight: bold;
    }

    @keyframes fadeOut {
      to { opacity: 0; backdrop-filter: blur(0); }
    }

    /* ===== MOBILE STYLES ===== */
    @media (max-width: 600px) {
      .game-container { 
        padding: 1rem 0.8rem; 
        max-height: 95vh;
        overflow-y: auto;
      }
      
      h1 { 
        font-size: 1.8rem; 
        text-align: center;
      }
      
      .sub { 
        font-size: 0.9rem; 
        margin: 0.5rem 0 1rem;
      }
      
      .ui-panel { 
        padding: 1rem 0.8rem; 
        margin: 0.8rem 0;
      }
      
      button { 
        min-width: 120px; 
        font-size: 0.9rem; 
        padding: 0.6rem 1rem;
      }
      
      .flex-row { 
        gap: 0.5rem; 
        justify-content: center;
      }
      
      .player-row { 
        padding: 0.6rem; 
        margin: 0.5rem 0;
      }
      
      .player-row input { 
        font-size: 0.9rem; 
        padding: 0.5rem;
      }
      
      .noble-tag { 
        font-size: 0.9rem; 
        padding: 0.3rem 0.8rem;
      }
      
      .pill-count { 
        font-size: 1rem; 
        padding: 0.3rem 1rem;
      }
      
      .guess-role { 
        font-size: 1.8rem; 
      }
      
      .guess-input { 
        font-size: 1rem; 
        padding: 0.8rem;
      }
      
      .leaderboard-entry { 
        font-size: 1.1rem; 
        padding: 0.8rem; 
      }
      
      .active-section {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .king-reveal .role {
        font-size: 3rem;
      }
      
      .king-reveal .points {
        font-size: 1.5rem;
      }
      
      .correct-card, .swap-card {
        font-size: 1.8rem;
        padding: 1.5rem;
        width: 90%;
      }
      
      .player-list-scroll {
        max-height: 280px;
      }
      
      #guessBtn, #nextRoundBtn, #leaderboardBtn, #newGameBtn {
        width: 100%;
        margin: 0.3rem 0;
      }
    }
  </style>
</head>
<body>
<div class="game-container" id="gameContainer">
  <h1>KALLANUM POLICEUM</h1>
  <div class="sub">üëë THE ROYAL DEDUCTION GAME üëë</div>
  <div id="appRoot"></div>
</div>

<script>
  (function(){
    // ===== COMPLETE HIERARCHY (11 roles) =====
    const HIERARCHY_BASE = [
      { role: 'King', points: 1000 },
      { role: 'Queen', points: 500 },
      { role: 'Manthri', points: 400 },
      { role: 'Commander', points: 350 },
      { role: 'Soldier', points: 300 },
      { role: 'Watchman', points: 250 },
      { role: 'Spy', points: 200 },
      { role: 'Gardener', points: 150 },
      { role: 'Milkman', points: 100 },
      { role: 'Police', points: 50 },
      { role: 'Thief', points: 0 }
    ];

    // ===== SOUND EFFECTS using Web Audio API =====
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    
    function initAudio() {
      if (audioCtx) return;
      try {
        audioCtx = new AudioContext();
      } catch(e) {
        console.log("Web Audio not supported");
      }
    }

    function playSound(type) {
      initAudio();
      if (!audioCtx) return;
      
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
      
      const now = audioCtx.currentTime;
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      switch(type) {
        case 'correct':
          oscillator.frequency.setValueAtTime(400, now);
          oscillator.frequency.exponentialRampToValueAtTime(1200, now + 0.4);
          gainNode.gain.setValueAtTime(0.4, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
          break;
          
        case 'swap':
          oscillator.type = 'sawtooth';
          oscillator.frequency.setValueAtTime(400, now);
          oscillator.frequency.exponentialRampToValueAtTime(80, now + 0.3);
          gainNode.gain.setValueAtTime(0.5, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
          break;
          
        case 'reveal':
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(600, now);
          oscillator.frequency.exponentialRampToValueAtTime(1200, now + 0.2);
          oscillator.frequency.exponentialRampToValueAtTime(400, now + 0.4);
          gainNode.gain.setValueAtTime(0.3, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
          break;
          
        case 'king':
          oscillator.frequency.setValueAtTime(500, now);
          oscillator.frequency.setValueAtTime(600, now + 0.15);
          oscillator.frequency.setValueAtTime(800, now + 0.3);
          gainNode.gain.setValueAtTime(0.4, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
          break;
          
        case 'setup':
          oscillator.frequency.setValueAtTime(300, now);
          gainNode.gain.setValueAtTime(0.1, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
          break;
      }
      
      oscillator.start(now);
      oscillator.stop(now + 0.8);
    }

    // ===== GAME STATE =====
    let players = [];
    let stage = 'START';
    let currentRevealIndex = 0;
    let activeRoleIndex = 0;
    let currentHierarchy = [];
    let roundStartScores = [];

    // ===== CORE LOGIC: GENERATE ROLES FOR PLAYER COUNT =====
    function generateRoleSet(playerCount) {
      let selectedRoles = ['King', 'Queen', 'Police', 'Thief'];
      const extraRoles = ['Manthri', 'Commander', 'Soldier', 'Watchman', 'Spy', 'Gardener', 'Milkman'];
      let extrasNeeded = playerCount - 4;
      
      for (let i = 0; i < extrasNeeded; i++) {
        if (i < extraRoles.length) {
          selectedRoles.splice(2 + i, 0, extraRoles[i]);
        }
      }
      return selectedRoles;
    }

    function resetSafe() {
      players.forEach(p => p.safe = false);
    }

    function shuffleRolesForRound() {
      const roleNames = generateRoleSet(players.length);
      const shuffled = [...roleNames];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      
      players.forEach((p, idx) => {
        p.role = shuffled[idx];
        p.safe = false;
      });
      
      currentHierarchy = roleNames;
    }

    function getActivePlayer() {
      if (!currentHierarchy.length || activeRoleIndex >= currentHierarchy.length) return null;
      let role = currentHierarchy[activeRoleIndex];
      return players.find(p => p.role === role);
    }

    function getNextRole() {
      if (activeRoleIndex + 1 < currentHierarchy.length) return currentHierarchy[activeRoleIndex + 1];
      return null;
    }

    function advanceToNextRole() {
      if (activeRoleIndex + 1 < currentHierarchy.length) {
        activeRoleIndex++;
        return true;
      }
      return false;
    }

    function getUnsafeNames() {
      return players.filter(p => !p.safe).map(p => p.name);
    }

    // ===== ANIMATION HELPERS =====
    function showCorrect(pts, role) {
      const overlay = document.createElement('div');
      overlay.className = 'effect-overlay';
      overlay.innerHTML = `
        <div class="correct-card">
          <div>CORRECT!</div>
          <div style="font-size:4rem; color: var(--gold);">+${pts}</div>
          <small>POINTS FOR THE ${role}</small>
        </div>
      `;
      document.body.appendChild(overlay);
      playSound('correct');
      
      setTimeout(() => {
        overlay.style.animation = 'fadeOut 0.5s forwards';
        setTimeout(() => {
          overlay.remove();
        }, 500);
      }

          function showSwap(activeName, guessedName, oldActiveRole, oldGuessedRole) {
      const overlay = document.createElement('div');
      overlay.className = 'effect-overlay';
      overlay.innerHTML = `
        <div class="swap-card">
          <div style="font-size:2rem; margin-bottom:1rem;">‚öîÔ∏è ROLE SWAP ‚öîÔ∏è</div>
          <div class="swap-detail">
            <span>${activeName}</span> ‚áÑ <span>${guessedName}</span><br>
            <small style="color: var(--parchment);">${oldActiveRole} ‚Üî ${oldGuessedRole}</small>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      playSound('swap');
      
      setTimeout(() => {
        overlay.style.animation = 'fadeOut 0.5s forwards';
        setTimeout(() => {
          overlay.remove();
        }, 500);
      }, 2000);
    }

    // ===== SMART NAME INPUT HANDLER =====
    function setupNameInputs() {
      for (let i = 0; i < players.length; i++) {
        const input = document.getElementById(`name_${i}`);
        if (input) {
          input.addEventListener('focus', function() {
            if (this.value === `Noble ${i+1}`) {
              this.value = '';
              this.classList.remove('default-name');
            }
          });
          
          input.addEventListener('blur', function() {
            if (this.value.trim() === '') {
              this.value = `Noble ${i+1}`;
              this.classList.add('default-name');
              players[i].name = `Noble ${i+1}`;
            } else {
              players[i].name = this.value.trim();
            }
          });
          
          if (input.value === `Noble ${i+1}`) {
            input.classList.add('default-name');
          }
        }
      }
    }

    // ===== RENDER FUNCTIONS =====
    const root = document.getElementById('appRoot');

    function render() {
      if (stage === 'START') renderStart();
      else if (stage === 'SETUP') renderSetup();
      else if (stage === 'REVEAL') renderReveal();
      else if (stage === 'KING_REVEAL') renderKingReveal();
      else if (stage === 'GUESS') renderGuess();
      else if (stage === 'ROUND_END') renderRoundEnd();
      else if (stage === 'LEADERBOARD') renderLeaderboard();
      else root.innerHTML = `<div class="ui-panel">‚ö†Ô∏è error</div>`;
    }

    function renderStart() {
      root.innerHTML = `
        <div class="ui-panel" style="text-align: center;">
          <div style="font-size: 3rem; margin: 0.5rem 0;">üè∞  üëë  üé≠</div>
          <p style="font-size: 1.2rem; margin: 1rem; color: var(--gold);">The Royal Deduction Game</p>
          <button id="startBtn" style="width: 100%;">‚ñ∂ START GAME</button>
        </div>
      `;
      document.getElementById('startBtn')?.addEventListener('click', ()=>{
        playSound('setup');
        stage = 'SETUP';
        players = [
          { name: 'Noble 1', role: '', score: 0, safe: false },
          { name: 'Noble 2', role: '', score: 0, safe: false },
          { name: 'Noble 3', role: '', score: 0, safe: false },
          { name: 'Noble 4', role: '', score: 0, safe: false }
        ];
        render();
      });
    }

    function renderSetup() {
      let rows = '';
      players.forEach((p, i) => {
        rows += `
          <div class="player-row">
            <span class="noble-tag">#${i+1}</span>
            <input type="text" id="name_${i}" value="${p.name}" placeholder="Enter name">
          </div>
        `;
      });
      
      root.innerHTML = `
        <div class="ui-panel">
          <div class="flex-row" style="justify-content: space-between;">
            <span class="pill-count">üë• ${players.length}/11</span>
            <div style="display: flex; gap: 0.5rem;">
              <button id="addBtn" ${players.length >= 11 ? 'disabled' : ''}>‚ûï ADD</button>
              <button id="removeBtn" ${players.length <= 4 ? 'disabled' : ''}>‚ûñ REMOVE</button>
            </div>
          </div>
          <div class="player-list-scroll" id="playerInputs">${rows}</div>
          <button id="revealRolesBtn" style="width:100%; margin-top:1rem;">üîê REVEAL ROLES</button>
        </div>
      `;
      
      setupNameInputs();
      
      document.getElementById('addBtn')?.addEventListener('click', ()=>{
        if (players.length < 11) {
          const playerNum = players.length + 1;
          players.push({ name: `Noble ${playerNum}`, role: '', score: 0, safe: false });
          playSound('setup');
          render();
        }
      });
      
      document.getElementById('removeBtn')?.addEventListener('click', ()=>{
        if (players.length > 4) {
          players.pop();
          playSound('setup');
          render();
        }
      });
      
      document.getElementById('revealRolesBtn')?.addEventListener('click', ()=>{
        for (let i = 0; i < players.length; i++) {
          let inp = document.getElementById(`name_${i}`);
          if (inp) {
            const val = inp.value.trim();
            players[i].name = val || `Noble ${i+1}`;
          }
        }
        
        roundStartScores = players.map(p => p.score);
        shuffleRolesForRound();
        resetSafe();
        currentRevealIndex = 0;
        stage = 'REVEAL';
        playSound('reveal');
        render();
      });
    }

    function renderReveal() {
      if (currentRevealIndex >= players.length) {
        stage = 'KING_REVEAL';
        render();
        return;
      }
      const p = players[currentRevealIndex];
      root.innerHTML = `
        <div class="ui-panel" style="text-align: center;">
          <div class="noble-tag" style="font-size:1.2rem; display:inline-block; background: var(--gold); color: var(--obsidian);">‚ú® ${p.name}'s turn ‚ú®</div>
          <div style="margin: 1.5rem 0;" id="revealBtnContainer">
            <button id="tapBtn" style="width:100%;">üëÅÔ∏è TAP TO REVEAL</button>
          </div>
          <div id="cardArea"></div>
        </div>
      `;
      document.getElementById('tapBtn')?.addEventListener('click', ()=>{
        playSound('reveal');
        const roleObj = HIERARCHY_BASE.find(r => r.role === p.role);
        const cardArea = document.getElementById('cardArea');
        cardArea.innerHTML = `
          <div class="role-card">
            ${p.role} <small>${roleObj.points} POINTS</small>
          </div>
        `;
        const btn = document.getElementById('tapBtn');
        btn.innerText = 'üôà HIDE & PASS';
        btn.onclick = ()=>{
          currentRevealIndex++;
          render();
        };
      });
    }

    function renderKingReveal() {
      root.innerHTML = `
        <div class="ui-panel king-reveal">
          <div style="font-size: 3rem; margin-bottom: 0.5rem;">üëë</div>
          <div class="label">CURRENT REVEAL</div>
          <div class="role">KING</div>
          <div class="points">1000 POINTS</div>
          <button id="startGuessBtn" style="width:100%;">‚öîÔ∏è PROCEED TO ROUND</button>
        </div>
      `;
      document.getElementById('startGuessBtn')?.addEventListener('click', ()=>{
        playSound('king');
        activeRoleIndex = 0;
        stage = 'GUESS';
        render();
      });
    }

    function renderGuess() {
      const active = getActivePlayer();
      if (!active) { stage = 'ROUND_END'; render(); return; }
      const nextRole = getNextRole();
      if (!nextRole) { stage = 'ROUND_END'; render(); return; }

      const unsafe = getUnsafeNames().filter(n => n !== active.name);
      const options = unsafe.map(n => `<option value="${n}">`).join('');

      root.innerHTML = `
        <div class="ui-panel">
          <div class="active-section">
            <span class="label">ACTIVE:</span>
            <span class="name">${active.name}</span>
            <span class="role">(${active.role})</span>
          </div>

          <div class="guess-section">
            <div class="guess-label">GUESS</div>
            <div class="guess-role">Who is the <span style="color: var(--gold);">${nextRole}</span>?</div>
            
            <input list="unsafeList" id="guessInput" class="guess-input" placeholder="Select player...">
            <datalist id="unsafeList">${options}</datalist>
            
            <button id="guessBtn" style="width:100%;">üéØ GUESS</button>
          </div>

          <div class="hierarchy-line">
            ${currentHierarchy.map((r,i)=>`<span class="hierarchy-item ${i===activeRoleIndex ? 'active' : ''}">${r}</span>`).join(' ‚Üí ')}
          </div>
          <p style="margin-top:1rem; text-align:center; color: var(--parchment); opacity:0.7;">‚úÖ safe: ${players.filter(p=>p.safe).map(p=>p.name).join(', ') || 'none'}</p>
        </div>
      `;

      document.getElementById('guessBtn')?.addEventListener('click', ()=>{
        const guessedName = document.getElementById('guessInput').value;
        const guessed = players.find(p => p.name === guessedName);
        if (!guessed || guessed.safe || guessed.name === active.name) {
          alert('Invalid guess!');
          return;
        }
        const nextRolePlayer = players.find(p => p.role === nextRole);
        const correct = (nextRolePlayer && nextRolePlayer.name === guessedName);

        if (correct) {
          const pts = HIERARCHY_BASE.find(h => h.role === active.role).points;
          active.score += pts;
          active.safe = true;
          
          showCorrect(pts, active.role);
          
          setTimeout(() => {
            if (active.role === 'Police' && nextRole === 'Thief') {
              stage = 'ROUND_END';
              render();
            } else {
              advanceToNextRole();
              render();
            }
          }, 2000);
          
        } else {
          const oldActiveRole = active.role;
          const oldGuessedRole = guessed.role;
          
          active.role = guessed.role;
          guessed.role = oldActiveRole;
          
          showSwap(active.name, guessed.name, oldActiveRole, oldGuessedRole);
          
          setTimeout(() => {
            render();
          }, 2000);
        }
      });
    }

    function renderRoundEnd() {
      const roundScores = players.map(p => ({
        name: p.name,
        roundScore: p.score - (roundStartScores[players.indexOf(p)] || 0)
      })).filter(rs => rs.roundScore > 0);

      const roundScoresHtml = roundScores.length ? 
        roundScores.map(rs => `<span class="round-score-badge">${rs.name}: +${rs.roundScore}</span>`).join(' ') :
        '<span class="round-score-badge">No points this round</span>';

      root.innerHTML = `
        <div class="ui-panel" style="text-align: center;">
          <h2 style="font-size: 1.8rem; color: var(--gold);">üèÅ ROUND FINISHED</h2>
          <div style="margin: 1.5rem 0;">
            <h3 style="font-size: 1.3rem; color: var(--deep-gold);">This Round:</h3>
            <div>${roundScoresHtml}</div>
          </div>
          <div style="font-size: 1.2rem; margin: 1.5rem 0; background: rgba(0,0,0,0.3); padding:1rem;">
            <strong style="color: var(--gold);">Total Scores:</strong><br>
            <span style="color: var(--parchment);">${players.map(p=>`${p.name} (${p.score})`).join(' ¬∑ ')}</span>
          </div>
          <div class="flex-row actions" style="justify-content:center;">
            <button id="nextRoundBtn">‚û°Ô∏è NEXT ROUND</button>
            <button id="leaderboardBtn">üìä FINAL</button>
          </div>
        </div>
      `;
      document.getElementById('nextRoundBtn')?.addEventListener('click', ()=>{
        playSound('setup');
        roundStartScores = players.map(p => p.score);
        shuffleRolesForRound();
        resetSafe();
        currentRevealIndex = 0;
        stage = 'REVEAL';
        render();
      });
      document.getElementById('leaderboardBtn')?.addEventListener('click', ()=>{
        stage = 'LEADERBOARD';
        render();
      });
    }

    function renderLeaderboard() {
      const sorted = [...players].sort((a,b)=> b.score - a.score);
      const entries = sorted.map((p,i)=>`
        <div class="leaderboard-entry">
          <span style="color: var(--parchment);">${i===0?'üëë ':''}${p.name}</span>
          <span class="score">${p.score} pts</span>
        </div>
      `).join('');
      root.innerHTML = `
        <div class="ui-panel">
          <h2 style="text-align:center; font-size: 1.8rem; color: var(--gold);">üëë FINAL RANKING</h2>
          <p style="text-align:center; color: var(--deep-gold);">Total points across all rounds</p>
          ${entries}
          <button id="newGameBtn" style="width:100%; margin-top:1.5rem;">üîÑ NEW GAME</button>
        </div>
      `;
      document.getElementById('newGameBtn')?.addEventListener('click', ()=>{
        stage = 'START';
        players = [];
        render();
      });
    }

    // Start the game
    render();
  })();
</script>
</body>
</html>
